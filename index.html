<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ANSINA MX Radio</title>

  <style>
    :root{
      --bg1:#0b0f1a; --bg2:#131b2e; --card:rgba(255,255,255,.06);
      --text:#e9eefc; --muted:rgba(233,238,252,.7); --accent:#7aa7ff;
      --stroke:rgba(255,255,255,.12);
    }
    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Arial;}
    body{
      margin:0; min-height:100vh; color:var(--text);
      background: radial-gradient(1200px 800px at 20% 10%, #1c2a55 0%, transparent 60%),
                  radial-gradient(1000px 700px at 80% 30%, #2a1c55 0%, transparent 55%),
                  linear-gradient(180deg,var(--bg1),var(--bg2));
      display:grid; place-items:center; padding:24px;
    }
    .wrap{width:min(860px,100%); display:grid; gap:16px;}
    .card{
      border:1px solid var(--stroke);
      background: var(--card);
      backdrop-filter: blur(10px);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
    }
    .top{display:flex; gap:14px; align-items:center;}
    .logo{
      width:72px;height:72px;border-radius:18px;
      border:1px solid var(--stroke);
      background:#0e1426;
      display:grid; place-items:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:cover;display:block;}
    h1{margin:0;font-size:22px;line-height:1.2}
    .sub{margin:6px 0 0;color:var(--muted);font-size:13px}

    .controls{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; margin-top:14px
    }
    button{
      border:1px solid var(--stroke);
      background:rgba(122,167,255,.14);
      color:var(--text);
      padding:12px 16px;
      border-radius:12px;
      cursor:pointer;
      font-weight:650;
      display:flex; gap:8px; align-items:center;
    }
    button:active{transform: translateY(1px);}
    .pill{
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.20);
      padding:12px 12px;
      border-radius:12px;
      color:var(--muted);
      font-size:13px;
      display:flex; gap:10px; align-items:center;
    }
    input[type="range"]{width:180px}

    .msg{
      margin-top:12px;
      border:1px dashed rgba(255,255,255,.25);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 12px;
      color: var(--muted);
      font-size: 13px;
    }
    .msg strong{color: var(--text);}
    .now{margin-top:12px;color:var(--muted);font-size:14px}
    .hint{margin-top:10px;color:var(--muted);font-size:12px}
    a{color:var(--accent); text-decoration:none}
    audio{display:none;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" id="card">
      <div class="top">
        <div class="logo">
          <img src="ansina-mix.png" alt="Ansina Mix">
        </div>
        <div>
          <h1>ANSINA MX Radio</h1>
          <div class="sub">En vivo ‚Ä¢ 24/7</div>
        </div>
      </div>

      <audio id="player" preload="none"></audio>

      <div class="controls">
        <button id="btnPlay">‚ñ∂ Reproducir</button>
        <button id="btnStop">‚èπ Detener</button>

        <div class="pill">
          Volumen
          <input id="vol" type="range" min="0" max="1" step="0.01" value="0.85">
        </div>

        <div class="pill" id="status">Listo</div>
      </div>

      <div class="msg" id="msg">
        üîä <strong>Para escuchar:</strong> toca ‚ÄúReproducir‚Äù. (En celular el audio NO puede iniciar solo).
      </div>

      <div class="now" id="now">üéµ Ahora: (cargando...)</div>

      <div class="hint">
        Stream directo:
        <a id="directLink" href="#" target="_blank" rel="noreferrer">/radio</a>
        <br>
        Tip: si abres desde WhatsApp/Facebook, usa ‚ÄúAbrir en Chrome‚Äù para menos bloqueos.
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const STREAM_URL = "https://7r4k0z.github.io/ansinamixradio.github.io";
    const NOWPLAYING_URL = "nowplaying.txt"; // (opcional) en el mismo folder

    const audio = document.getElementById("player");
    const btnPlay = document.getElementById("btnPlay");
    const btnStop = document.getElementById("btnStop");
    const vol = document.getElementById("vol");
    const status = document.getElementById("status");
    const msg = document.getElementById("msg");
    const now = document.getElementById("now");
    const directLink = document.getElementById("directLink");
    const card = document.getElementById("card");

    directLink.href = STREAM_URL;
    directLink.textContent = STREAM_URL;

    function setStatus(t){ status.textContent = t; }
    function setMsg(t){ msg.innerHTML = t; }

    function setSource(cacheBust=false){
      const url = cacheBust ? (STREAM_URL + (STREAM_URL.includes("?") ? "&" : "?") + "t=" + Date.now()) : STREAM_URL;
      audio.src = url;
    }

    function explainError(err){
      const name = err && err.name ? err.name : "";
      if (name === "NotAllowedError") {
        // Esto es el AUTOPLAY REAL
        setStatus("Bloqueado por navegador");
        setMsg("üîí <strong>Autoplay bloqueado:</strong> toca ‚ÄúReproducir‚Äù otra vez. Si est√°s en un navegador dentro de app, usa <strong>Abrir en Chrome</strong>.");
        return;
      }
      if (name === "NotSupportedError") {
        setStatus("Formato/stream no soportado");
        setMsg("‚ö†Ô∏è <strong>No soportado:</strong> este navegador no pudo reproducir el stream. Prueba abrir en Chrome o usa el link directo.");
        return;
      }
      // NetworkError / AbortError / etc
      setStatus("Error de conexi√≥n");
      setMsg("üåê <strong>No conect√≥ al stream:</strong> puede ser el tunnel (trycloudflare) o la red. Intenta de nuevo.");
    }

    async function playSafe(userClick){
      try{
        setStatus("Cargando...");
        audio.volume = Number(vol.value);

        // clave: set src + load() dentro del click
        setSource(false);
        audio.load();

        await audio.play();
        setStatus("Reproduciendo ‚úÖ");
        setMsg("‚úÖ <strong>Al aire:</strong> ya est√°s escuchando ANSINA MX Radio.");
      }catch(err){
        // Reintento 1: cache bust
        try{
          setStatus("Reintentando...");
          setSource(true);
          audio.load();
          await audio.play();
          setStatus("Reproduciendo ‚úÖ");
          setMsg("‚úÖ <strong>Al aire:</strong> ya est√°s escuchando ANSINA MX Radio.");
        }catch(err2){
          explainError(err2);
        }
      }
    }

    btnPlay.addEventListener("click", () => playSafe(true));

    // En m√≥vil ayuda que tocar la tarjeta tambi√©n funcione
    card.addEventListener("click", (e) => {
      if (e.target && e.target.tagName === "A") return;
      if (!audio.paused) return;
      playSafe(true);
    });

    btnStop.addEventListener("click", () => {
      audio.pause();
      audio.currentTime = 0;
      setStatus("Detenido");
      setMsg("üîä <strong>Para escuchar:</strong> toca ‚ÄúReproducir‚Äù.");
    });

    vol.addEventListener("input", () => {
      audio.volume = Number(vol.value);
    });

    audio.addEventListener("waiting", ()=> setStatus("Cargando..."));
    audio.addEventListener("playing", ()=> setStatus("Reproduciendo ‚úÖ"));
    audio.addEventListener("pause", ()=> { if(audio.currentTime>0) setStatus("Pausado"); });
    audio.addEventListener("error", ()=> {
      // Cuando el tag dispara error, casi siempre es stream/red
      setStatus("Error de audio");
      setMsg("‚ö†Ô∏è <strong>Error de audio:</strong> el stream no respondi√≥. Si tu link es trycloudflare, puede haber cambiado. Revisa el link.");
    });

    // NOW PLAYING (si existe nowplaying.txt)
    async function refreshNow(){
      try{
        const r = await fetch(NOWPLAYING_URL + "?t=" + Date.now(), { cache: "no-store" });
        if(!r.ok) throw new Error("no now");
        const t = (await r.text()).trim();
        now.textContent = t ? ("üéµ Ahora: " + t) : "üéµ Ahora: ANSINA MX Radio";
      }catch{
        now.textContent = "üéµ Ahora: ANSINA MX Radio";
      }
    }
    refreshNow();
    setInterval(refreshNow, 5000);

    // Importante: NO hacemos autoplay.
    setStatus("Listo");
  </script>
</body>
</html>
